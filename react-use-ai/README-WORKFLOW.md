# 多步骤工作流设计器

这是一个基于React和TypeScript开发的多步骤工作流配置和执行系统，支持可视化设计、依赖关系管理和动态执行。

## 功能特性

### 🎯 核心功能
- **可视化工作流设计**: 拖拽式步骤配置，直观的流程设计界面
- **步骤依赖管理**: 支持复杂的步骤间依赖关系，自动检测循环依赖
- **多种步骤类型**: 文件处理、数据转换、API调用、条件判断等
- **实时执行监控**: 步骤状态实时更新，支持并发执行
- **工作流管理**: 保存、加载、导入、导出工作流配置

### 📋 步骤类型

1. **文件处理** (`file_process`)
   - 支持多文件输入
   - 自定义输出路径和文件类型
   - 基于现有FileProcessForm组件的处理逻辑

2. **数据转换** (`data_transform`)
   - 数据格式转换
   - 自定义转换规则
   - 支持链式数据处理

3. **API调用** (`api_call`)
   - HTTP请求配置
   - 超时和重试机制
   - 响应数据处理

4. **条件判断** (`condition`)
   - 基于前置步骤结果的条件分支
   - 支持复杂表达式
   - 动态流程控制

### 🔗 依赖关系

- **步骤依赖**: 每个步骤可以依赖多个前置步骤
- **数据依赖**: 输入可以引用前置步骤的输出结果
- **可视化图表**: 依赖关系图直观展示步骤间的关联
- **循环检测**: 自动检测并阻止循环依赖的创建

## 使用指南

### 1. 创建工作流

1. 访问"工作流管理"页面
2. 点击"创建工作流"按钮
3. 输入工作流名称和描述
4. 进入工作流设计器

### 2. 添加步骤

1. 在工作流设计器中点击"添加步骤"
2. 配置步骤基本信息：
   - 步骤名称
   - 步骤类型
   - 步骤描述
   - 依赖关系

### 3. 配置输入

每个步骤支持多种输入类型：

- **文件输入**: 选择要处理的文件
- **提示词输入**: 添加处理指令或提示
- **数据输入**: 输入结构化数据或引用前置步骤输出

### 4. 设置依赖

- 在步骤配置中选择依赖的前置步骤
- 输入项可以指定依赖特定步骤的输出
- 系统会自动验证依赖关系的有效性

### 5. 执行工作流

1. 完成所有步骤配置后点击"执行工作流"
2. 系统按依赖关系自动排序执行
3. 实时监控每个步骤的执行状态
4. 查看执行结果和错误信息

## 技术架构

### 组件结构

```
WorkflowDesigner/          # 主设计器组件
├── StepCard              # 步骤卡片组件
├── StepForm              # 步骤配置表单
├── DependencyGraph       # 依赖关系可视化
└── WorkflowManager       # 工作流管理器
```

### 数据模型

```typescript
interface WorkflowStep {
  id: string;
  name: string;
  description: string;
  type: 'file_process' | 'data_transform' | 'api_call' | 'condition';
  config: {
    inputs: InputConfig[];
    outputFolder?: string;
    outputFileName?: string;
    outputFileType?: string;
    customSettings?: Record<string, any>;
  };
  dependencies: string[];
  status: 'pending' | 'running' | 'success' | 'error' | 'skipped';
  result?: any;
  order: number;
}

interface Workflow {
  id: string;
  name: string;
  description: string;
  steps: WorkflowStep[];
  createdAt: Date;
  updatedAt: Date;
}
```

### 执行引擎

- **依赖解析**: 基于拓扑排序的依赖关系解析
- **并发执行**: 支持无依赖步骤的并发执行
- **错误处理**: 完善的错误捕获和状态管理
- **结果传递**: 步骤间数据自动传递和引用

## 扩展开发

### 添加新的步骤类型

1. 在`WorkflowStep['type']`中添加新类型
2. 在`StepCard`组件中添加对应图标和样式
3. 在`StepForm`组件中添加特定配置界面
4. 在执行引擎中实现具体的执行逻辑

### 自定义输入类型

1. 扩展`InputConfig`接口
2. 在`StepForm`中添加新的输入组件
3. 更新验证逻辑和数据处理

### 集成外部服务

- 修改执行引擎以调用实际的后端API
- 添加认证和权限管理
- 实现工作流的持久化存储

## 最佳实践

### 工作流设计

1. **模块化设计**: 将复杂流程拆分为独立的步骤
2. **合理依赖**: 避免不必要的依赖关系，提高并发性
3. **错误处理**: 为关键步骤添加错误处理和重试机制
4. **文档说明**: 为每个步骤添加清晰的描述

### 性能优化

1. **并发执行**: 充分利用步骤间的并发执行能力
2. **资源管理**: 合理配置超时时间和重试次数
3. **数据传递**: 避免传递大量不必要的数据
4. **状态管理**: 及时清理执行完成的步骤状态

### 调试技巧

1. **依赖关系图**: 使用可视化图表检查依赖关系
2. **步骤日志**: 查看每个步骤的执行结果和错误信息
3. **单步执行**: 可以单独测试特定步骤的配置
4. **工作流导出**: 导出配置进行版本管理和备份

## 示例工作流

### 文件批处理工作流

```
步骤1: 文件扫描 (file_process)
├── 输入: 源目录路径
└── 输出: 文件列表

步骤2: 文件过滤 (condition)
├── 依赖: 步骤1
├── 输入: 文件列表, 过滤条件
└── 输出: 过滤后的文件列表

步骤3: 批量转换 (data_transform)
├── 依赖: 步骤2
├── 输入: 文件列表, 转换规则
└── 输出: 转换结果

步骤4: 结果通知 (api_call)
├── 依赖: 步骤3
├── 输入: 转换结果
└── 输出: 通知状态
```

## 故障排除

### 常见问题

1. **循环依赖**: 检查步骤间的依赖关系，确保没有形成环路
2. **执行卡住**: 检查步骤配置是否完整，输入数据是否有效
3. **保存失败**: 确保浏览器支持localStorage，检查数据格式
4. **导入错误**: 验证JSON格式是否正确，数据结构是否完整

### 调试方法

1. 打开浏览器开发者工具查看控制台错误
2. 使用依赖关系图检查工作流结构
3. 逐步执行工作流，定位问题步骤
4. 检查localStorage中的数据完整性

## 更新日志

### v1.0.0
- 初始版本发布
- 基础工作流设计和执行功能
- 支持四种基本步骤类型
- 可视化依赖关系图
- 工作流管理和持久化

---

如有问题或建议，请联系开发团队。